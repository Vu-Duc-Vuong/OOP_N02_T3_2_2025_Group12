<!doctype html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Hotel Core Flow </title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
  <style>
    :root{ --bg:#f8fafc; --card:#ffffff; --brand:#4f46e5; --text:#0f172a; --muted:#64748b; --radius:16px; }
    body{ background: radial-gradient(1400px 700px at -10% -10%, #eaeffd, transparent),
                   radial-gradient(1200px 600px at 110% -10%, #e6fffb, transparent),
                   var(--bg); color: var(--text); }
    .navbar{ background:#ffffffcc; backdrop-filter: blur(6px); border-bottom:1px solid rgba(15,23,42,.08); }
    .card{ background:var(--card); border:1px solid rgba(15,23,42,.08); border-radius:var(--radius); box-shadow:0 12px 28px rgba(2,8,23,.06); }
    .form-control,.form-select{ border-radius:12px; }
    .btn-brand{ background:var(--brand); color:#fff; border:none; }
    .btn-brand:hover{ filter: brightness(1.05); }
    .btn-soft{ background:rgba(79,70,229,.12); color:#312e81; border:1px solid rgba(79,70,229,.25); }
    .pill{ font-size:.75rem; padding:.2rem .5rem; border-radius:999px; background:rgba(15,23,42,.06); color:#334155;}
    .muted{ color:var(--muted); }
    .table thead th{ color:#334155; }
    .section-title{ display:flex; align-items:center; gap:.5rem; margin-bottom:.5rem; }
    .section-title .pill{ background:#eef2ff; color:#3730a3; }
    .btn-xs{ padding:.25rem .6rem; font-size:.8rem; border-radius:10px; }
    .table-wrap{ max-height:360px; overflow:auto; }
    .table-wrap thead th{ position:sticky; top:0; background:#fff; }
    .small-muted{ font-size:.85rem; color:var(--muted); }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg sticky-top">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#">üè® Hotel Dashboard</a>
    <span class="pill ms-auto">Kh√°ch h√†ng ‚Üí T√¨m ph√≤ng ‚Üí ƒê·∫∑t/Thanh to√°n ‚Üí D·ªãch v·ª• ‚Üí Ho√° ƒë∆°n</span>
  </div>
</nav>

<div class="container my-4">
  <!-- 0+1+2) KH√ÅCH H√ÄNG + T√åM PH√íNG TR·ªêNG + ƒê·∫∂T/THANH TO√ÅN (G·ªòP CHUNG 1 CARD) -->
<div class="row g-4">
  <div class="col-12">
    <div class="card p-3 p-md-4">

      <!-- 0) KH√ÅCH H√ÄNG -->
      <div class="section-title">
        <h5 class="mb-0">0) Kh√°ch h√†ng</h5>
        <span class="pill">/api/khach</span>
      </div>
      <div class="row g-3">
        <div class="col-12 col-md-3">
          <label class="form-label">ƒê·ªãnh danh (CCCD/Passport) *</label>
          <input id="kh_dinhDanh" class="form-control" placeholder="VD: 0123456789"/>
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label">H·ªç t√™n *</label>
          <input id="kh_hoTen" class="form-control" placeholder="VD: Nguy·ªÖn VƒÉn A"/>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Gi·ªõi t√≠nh</label>
          <select id="kh_gioiTinh" class="form-select">
            <option value="">--</option><option>NAM</option><option>NU</option><option>KHAC</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Ng√†y sinh</label>
          <input id="kh_ngaySinh" type="date" class="form-control"/>
        </div>
        <div class="col-6 col-md-2">
          <label class="form-label">Qu·ªëc t·ªãch</label>
          <input id="kh_quocTich" class="form-control" placeholder="VN, US, ..."/>
        </div>

        <div class="col-6 col-md-3">
          <label class="form-label">SƒêT</label>
          <input id="kh_sdt" class="form-control" placeholder="09xxxxxxxx"/>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Email</label>
          <input id="kh_email" type="email" class="form-control" placeholder="email@domain.com"/>
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label">ƒê·ªãa ch·ªâ</label>
          <input id="kh_diaChi" class="form-control" placeholder="S·ªë nh√†, ƒë∆∞·ªùng, qu·∫≠n/huy·ªán, t·ªânh/th√†nh"/>
        </div>

        <div class="col-12 d-flex flex-wrap gap-2">
          <button class="btn btn-soft" id="btnKiemTraKH">Ki·ªÉm tra KH</button>
          <button class="btn btn-brand" id="btnLuuKH">L∆∞u KH (t·∫°o/c·∫≠p nh·∫≠t)</button>
          <button class="btn btn-outline-danger" id="btnXoaKH">Xo√° KH</button>
          <span class="muted">* B·∫Øt bu·ªôc: ƒê·ªãnh danh & H·ªç t√™n khi t·∫°o m·ªõi</span>
        </div>
      </div>

      <hr class="my-4"/>

      <!-- 1) T√åM PH√íNG TR·ªêNG -->
      <div class="section-title">
        <h5 class="mb-0">1) T√¨m ph√≤ng tr·ªëng</h5>
        <span class="pill">POST /api/dat-phong/tim-phong-trong</span>
      </div>
      <div class="row g-3">
        <div class="col-6 col-md-3"><label class="form-label">Ng√†y nh·∫≠n</label><input id="nhan" type="date" class="form-control"/></div>
        <div class="col-6 col-md-3"><label class="form-label">Ng√†y tr·∫£</label><input id="tra" type="date" class="form-control"/></div>
        <div class="col-6 col-md-3"><label class="form-label">S·ªë kh√°ch</label><input id="soNguoi" type="number" class="form-control" min="1" value="1"/></div>
        <div class="col-6 col-md-3">
          <label class="form-label">Lo·∫°i ph√≤ng</label>
          <select id="loaiPhong" class="form-select">
            <option value="">-- B·∫•t k·ª≥ --</option><option>DON</option><option>DOI</option><option>SUITE</option><option>FAMILY</option><option>DELUXE</option>
          </select>
        </div>
        <div class="col-12">
          <button class="btn btn-brand me-2" id="btnTim">T√¨m ph√≤ng tr·ªëng</button>
          <span class="muted">D·ªØ li·ªáu t·ª´ DB qua API.</span>
        </div>
      </div>

      <div class="table-responsive table-wrap mt-3">
        <table class="table table-sm align-middle">
          <thead><tr><th>M√£ ph√≤ng</th><th>Lo·∫°i</th><th>S·ª©c ch·ª©a</th><th>Gi√°/ƒë√™m</th><th>T√¨nh tr·∫°ng</th><th></th></tr></thead>
          <tbody id="tblPhongTrong"><tr><td colspan="6" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr></tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center mt-2">
        <div class="muted" id="pagerInfo">0/0</div>
        <div class="btn-group">
          <button class="btn btn-outline-secondary btn-sm" id="btnPrev">Tr∆∞·ªõc</button>
          <button class="btn btn-outline-secondary btn-sm" id="btnNext">Sau</button>
        </div>
      </div>

      <hr class="my-4"/>

      <!-- 2) ƒê·∫∂T PH√íNG & THANH TO√ÅN -->
      <div class="section-title">
        <h5 class="mb-0">2) ƒê·∫∑t ph√≤ng & thanh to√°n (orchestrator)</h5>
        <span class="pill">POST /api/core-flow/dat-phong-thanh-toan</span>
      </div>
      <div class="row g-3">
        <div class="col-12 col-md-3"><label class="form-label">ƒê·ªãnh danh KH</label><input id="dinhDanhKhach" class="form-control" placeholder="ƒê·ªìng b·ªô t·ª´ m·ª•c 0)"/></div>
        <div class="col-12 col-md-3"><label class="form-label">M√£ ph√≤ng</label><input id="maPhong" class="form-control" placeholder="Ch·ªçn ·ªü b·∫£ng"/></div>
        <div class="col-6 col-md-2"><label class="form-label">S·ªë kh√°ch</label><input id="soKhach" type="number" class="form-control" min="1" value="1"/></div>
        <div class="col-6 col-md-2"><label class="form-label">Gi·∫£m gi√° (VND)</label><input id="giamGia" type="number" min="0" value="0" class="form-control"/></div>
        <div class="col-12 col-md-2">
          <label class="form-label">Ph∆∞∆°ng th·ª©c</label>
          <select id="phuongThuc" class="form-select"><option>TIEN_MAT</option><option>THE</option><option>CHUYEN_KHOAN</option><option>VI_DIEN_TU</option></select>
        </div>
        <div class="col-12">
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-brand" id="btnDatThanhToan">ƒê·∫∑t ph√≤ng & Thanh to√°n</button>
            <span class="muted">C√≥ th·ªÉ th√™m d·ªãch v·ª• sau khi t·∫°o ‚Äî xem kh·ªëi ‚ÄúD·ªãch v·ª•‚Äù.</span>
          </div>
        </div>
      </div>
      <div class="mt-3"><div id="status" class="muted">Ch∆∞a c√≥ ƒë·∫∑t ph√≤ng.</div></div>

    </div>
  </div>
</div>


  <!-- 3) D·ªäCH V·ª§ & 4) HO√Å ƒê∆†N -->
  <div class="row g-4 mt-1">
    <!-- D·ªäCH V·ª§ -->
    <div class="col-12 col-lg-6">
      <div class="card p-3 p-md-4">
        <div class="section-title">
          <h5 class="mb-0">3) D·ªãch v·ª• theo booking</h5>
          <span class="pill">/api/ctdv/booking/{maDP}</span>
        </div>

        <!-- Ch·ªçn booking theo KH ho·∫∑c nh·∫≠p M√£ DP -->
        <div class="row g-3">
          <div class="col-6">
            <label class="form-label">ƒê·ªãnh danh KH</label>
            <div class="input-group">
              <input id="dv_dinhDanh" class="form-control" placeholder="Nh·∫≠p ƒë·ªãnh danh KH"/>
              <button class="btn btn-soft" id="btnLoadBooking">T·∫£i booking</button>
            </div>
            <div class="small-muted mt-1">M·∫πo: ƒë·ªÉ tr·ªëng s·∫Ω d√πng booking v·ª´a t·∫°o (n·∫øu c√≥).</div>
          </div>
          <div class="col-6">
            <label class="form-label">Booking c·ªßa KH</label>
            <select id="selBooking" class="form-select"></select>
            <div class="small-muted mt-1">Ch·ªçn ƒë·ªÉ set M√£ DP v√† t·∫£i DV/Ho√° ƒë∆°n.</div>
          </div>
          <div class="col-12">
            <label class="form-label">M√£ ƒë·∫∑t ph√≤ng (tu·ª≥ ch·ªçn)</label>
            <input id="dpMaDP" class="form-control" placeholder="VD: DP-xxxx"/>
          </div>
        </div>

        <div class="row g-3 mt-1">
          <div class="col-8">
            <label class="form-label">D·ªãch v·ª•</label>
            <select id="selDichVu" class="form-select"></select>
          </div>
          <div class="col-2">
            <label class="form-label">S·ªë l∆∞·ª£ng</label>
            <input id="soLuongDV" type="number" min="1" value="1" class="form-control"/>
          </div>
          <div class="col-2 d-flex align-items-end">
            <button class="btn btn-brand w-100" id="btnThemDV">Th√™m</button>
          </div>
        </div>

        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle">
            <thead><tr><th>ID</th><th>M√£ DV</th><th>S·ªë l∆∞·ª£ng</th><th>Th√†nh ti·ªÅn</th><th></th></tr></thead>
            <tbody id="tblCTDV"><tr><td colspan="5" class="muted">Ch∆∞a c√≥ d·ªãch v·ª•</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- HO√Å ƒê∆†N -->
    <div class="col-12 col-lg-6">
      <div class="card p-3 p-md-4">
        <div class="section-title">
          <h5 class="mb-0">4) Ho√° ƒë∆°n</h5>
          <span class="pill">/api/hoa-don | /api/dat-phong/khach/{id} ‚Üí /api/hoa-don/booking/{maDP}</span>
        </div>

        <div class="d-flex flex-wrap align-items-end gap-2">
          <div class="btn-group" role="group" aria-label="invoice-view">
            <button class="btn btn-soft" id="btnHDAll">Xem t·∫•t c·∫£</button>
            <button class="btn btn-soft" id="btnHDByKh">Theo kh√°ch</button>
          </div>
          <div class="ms-auto d-flex align-items-end gap-2">
            <div>
              <label class="form-label">ƒê·ªãnh danh KH</label>
              <input id="hdKhDinhDanh" class="form-control" placeholder="Nh·∫≠p ƒë·ªãnh danh ƒë·ªÉ l·ªçc"/>
            </div>
            <button class="btn btn-brand" id="btnLoadHDByKh">T·∫£i</button>
          </div>
        </div>

        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>M√£ Hƒê</th><th>Ph√≤ng</th><th>D·ªãch v·ª•</th><th>Thu·∫ø</th><th>Gi·∫£m</th><th>Ph·∫£i tr·∫£</th><th>Ng√†y TT</th><th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody id="tblHDList"><tr><td colspan="8" class="muted">Ch∆∞a c√≥ ho√° ƒë∆°n</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 5) QU·∫¢N TR·ªä: TH√äM/XO√Å PH√íNG & D·ªäCH V·ª§ -->
  <div class="row g-4 mt-1">
    <!-- Ph√≤ng -->
    <div class="col-12 col-lg-6">
      <div class="card p-3 p-md-4">
        <div class="section-title"><h5 class="mb-0">5) Ph√≤ng</h5><span class="pill">/api/core-flow/them-phong & /api/phong</span></div>
        <div class="row g-3">
          <div class="col-4"><label class="form-label">M√£ ph√≤ng</label><input id="newMaPhong" class="form-control"/></div>
          <div class="col-4"><label class="form-label">Lo·∫°i</label><select id="newLoaiPhong" class="form-select"><option>DON</option><option>DOI</option><option>SUITE</option><option>FAMILY</option><option>DELUXE</option></select></div>
          <div class="col-4"><label class="form-label">Gi√°/ƒë√™m</label><input id="newGia" type="number" min="0" value="0" class="form-control"/></div>
          <div class="col-4"><label class="form-label">T√¨nh tr·∫°ng</label><select id="newTinhTrang" class="form-select"><option>TRONG</option><option>DA_DAT</option><option>DANG_O</option><option>BAO_TRI</option></select></div>
          <div class="col-4"><label class="form-label">S·ª©c ch·ª©a</label><input id="newSucChua" type="number" min="1" value="2" class="form-control"/></div>
          <div class="col-12"><label class="form-label">Ti·ªán nghi</label><input id="newTienNghi" class="form-control" placeholder="WiFi, TV, ..."/></div>
          <div class="col-12 d-flex flex-wrap gap-2">
            <button class="btn btn-brand" id="btnThemPhong">Th√™m ph√≤ng</button>
            <div class="input-group" style="max-width:360px">
              <input id="delMaPhong" class="form-control" placeholder="M√£ ph√≤ng c·∫ßn xo√° (c·∫©n th·∫≠n FK)"/>
              <button class="btn btn-outline-danger" id="btnXoaPhong">Xo√° ph√≤ng</button>
            </div>
            <a class="btn btn-soft" href="/api/phong" target="_blank">Xem danh s√°ch ph√≤ng</a>
          </div>
          <div class="small-muted">L∆∞u √Ω: Xo√° ph√≤ng c√≥ th·ªÉ th·∫•t b·∫°i n·∫øu ƒëang ƒë∆∞·ª£c tham chi·∫øu ·ªü ƒë·∫∑t ph√≤ng.</div>
        </div>
      </div>
    </div>

    <!-- D·ªãch v·ª• -->
    <div class="col-12 col-lg-6">
      <div class="card p-3 p-md-4">
        <div class="section-title"><h5 class="mb-0">6) D·ªãch v·ª•</h5><span class="pill">/api/core-flow/them-dich-vu & /api/dich-vu</span></div>
        <div class="row g-3">
          <div class="col-4"><label class="form-label">M√£ DV</label><input id="newMaDV" class="form-control"/></div>
          <div class="col-8"><label class="form-label">T√™n DV</label><input id="newTenDV" class="form-control"/></div>
          <div class="col-4"><label class="form-label">Gi√°</label><input id="newGiaDV" type="number" min="0" value="0" class="form-control"/></div>
          <div class="col-4"><label class="form-label">Lo·∫°i</label><select id="newLoaiDV" class="form-select"><option>THEO_LAN</option><option>THEO_GIO</option></select></div>
          <div class="col-12 d-flex flex-wrap gap-2">
            <button class="btn btn-brand" id="btnThemDVAdmin">Th√™m d·ªãch v·ª•</button>
            <div class="input-group" style="max-width:360px">
              <input id="delMaDV" class="form-control" placeholder="M√£ DV c·∫ßn xo√° (c·∫©n th·∫≠n FK)"/>
              <button class="btn btn-outline-danger" id="btnXoaDV">Xo√° d·ªãch v·ª•</button>
            </div>
            <a class="btn btn-soft" href="/api/dich-vu" target="_blank">Xem danh s√°ch d·ªãch v·ª•</a>
          </div>
          <div class="small-muted">L∆∞u √Ω: Xo√° DV c√≥ th·ªÉ th·∫•t b·∫°i n·∫øu ƒëang c√≥ chi ti·∫øt DV tham chi·∫øu.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 7) B√ÅO C√ÅO -->
<div class="row g-4 mt-1">
  <div class="col-12">
    <div class="card p-3 p-md-4">
      <div class="section-title">
        <h5 class="mb-0">7) B√°o c√°o</h5>
        <span class="pill">/api/bao-cao/*</span>
      </div>

      <div class="row g-3 align-items-end">
        <div class="col-6 col-md-3">
          <label class="form-label">NƒÉm</label>
          <input id="rp_year" type="number" class="form-control" min="2000" value="2025"/>
        </div>
        <div class="col-6 col-md-3">
          <label class="form-label">Th√°ng</label>
          <input id="rp_month" type="number" class="form-control" min="1" max="12" value="8"/>
        </div>
        <div class="col-12 col-md-3">
          <button class="btn btn-brand w-100" id="btnLoadReport">T·∫£i b√°o c√°o</button>
        </div>
      </div>

      <!-- KPI -->
      <div class="row g-3 mt-2">
        <div class="col-6 col-lg-2"><div class="card p-3"><div class="muted">T·ªïng</div><div id="kpi_tong" class="fs-5 fw-bold">0</div></div></div>
        <div class="col-6 col-lg-2"><div class="card p-3"><div class="muted">Ti·ªÅn ph√≤ng</div><div id="kpi_phong" class="fs-5 fw-bold">0</div></div></div>
        <div class="col-6 col-lg-2"><div class="card p-3"><div class="muted">D·ªãch v·ª•</div><div id="kpi_dv" class="fs-5 fw-bold">0</div></div></div>
        <div class="col-6 col-lg-2"><div class="card p-3"><div class="muted">Thu·∫ø</div><div id="kpi_thue" class="fs-5 fw-bold">0</div></div></div>
        <div class="col-6 col-lg-2"><div class="card p-3"><div class="muted">Gi·∫£m gi√°</div><div id="kpi_giam" class="fs-5 fw-bold">0</div></div></div>
        <div class="col-6 col-lg-2"><div class="card p-3"><div class="muted">% C√¥ng su·∫•t</div><div id="kpi_occ" class="fs-5 fw-bold">0%</div></div></div>
      </div>

      <div class="row g-4 mt-1">
        <div class="col-12 col-lg-6">
          <div class="card p-3">
            <div class="section-title"><h6 class="mb-0">C√¥ng su·∫•t ph√≤ng</h6></div>
            <canvas id="chartOcc" height="220"></canvas>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card p-3">
            <div class="section-title"><h6 class="mb-0">D·ªãch v·ª• b√°n ch·∫°y</h6></div>
            <canvas id="chartDV" height="220"></canvas>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1055">
  <div id="toast" class="toast text-bg-dark border-0" role="alert" data-bs-delay="2500">
    <div class="d-flex"><div class="toast-body" id="toastBody">...</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
  </div>
</div>
<script>
/* ================== GLOBAL LOADING OVERLAY (auto for all requests) ================== */
// 1) chu·∫©n b·ªã overlay (t·∫°o n·∫øu ch∆∞a c√≥)
(function ensureOverlay(){
  if (!document.getElementById('loadingOverlay')) {
    const el = document.createElement('div');
    el.id = 'loadingOverlay';
    el.className = 'loading-overlay';
    el.setAttribute('aria-hidden', 'true');
    el.innerHTML = `
      <div class="loading-box">
        <div class="loading-spinner"></div>
        <div class="msg">ƒêang t·∫£i...</div>
      </div>`;
    document.body.appendChild(el);
  }
  // CSS t·ªëi thi·ªÉu n·∫øu trang b·∫°n ch∆∞a c√≥
  const needStyle = !document.getElementById('loadingOverlayStyle');
  if (needStyle) {
    const style = document.createElement('style');
    style.id = 'loadingOverlayStyle';
    style.textContent = `
      .loading-overlay{position:fixed;inset:0;background:rgba(15,23,42,.25);
        backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:2000}
      .loading-overlay.show{display:flex}
      .loading-box{background:#fff;color:#0f172a;border-radius:14px;padding:12px 16px;
        box-shadow:0 10px 24px rgba(2,8,23,.18);display:flex;align-items:center;gap:12px;min-width:220px}
      .loading-spinner{width:22px;height:22px;border:3px solid #e5e7eb;border-top-color:#4f46e5;border-radius:50%;
        animation:spin .8s linear infinite}
      @keyframes spin{to{transform:rotate(360deg)}}
    `;
    document.head.appendChild(style);
  }
})();

// 2) b·ªô ƒë·∫øm & helper show/hide (debounce ƒë·ªÉ tr√°nh nh√°y)
(function globalLoading(){
  const overlay = document.getElementById('loadingOverlay');
  let active = 0, showTimer=null, hideTimer=null;
  const SHOW_DELAY = 120; // ms
  const HIDE_DELAY = 180; // ms

  function show(msg){
    if(!overlay) return;
    if (msg) overlay.querySelector('.msg').textContent = msg;
    overlay.classList.add('show');
  }
  function hide(){
    overlay?.classList.remove('show');
  }

  function inc(url){
    if (active++ === 0){
      clearTimeout(hideTimer);
      showTimer = setTimeout(()=> show('ƒêang t·∫£i...'), SHOW_DELAY);
    }
  }
  function dec(){
    if (active > 0 && --active === 0){
      clearTimeout(showTimer);
      hideTimer = setTimeout(hide, HIDE_DELAY);
    }
  }

  // Cho ph√©p c·∫•u h√¨nh b·ªè qua 1 s·ªë request (tu·ª≥ ch·ªçn)
  // G√°n window.GLOBAL_LOADING_IGNORE = [ /\/favicon\.ico$/, /\.png$/ ] tr∆∞·ªõc khi ƒëo·∫°n n√†y ch·∫°y ƒë·ªÉ b·ªè qua.
  const shouldTrack = (input)=>{
    try{
      const list = (window.GLOBAL_LOADING_IGNORE || []);
      const url = typeof input === 'string' ? input
                : (input && input.url) ? input.url
                : String(input);
      return !list.some(rx => rx.test(url));
    }catch{ return true; }
  };

  // 3) patch fetch
  const _fetch = window.fetch;
  if (_fetch) {
    window.fetch = function(input, init){
      if (shouldTrack(input)) inc(input);
      try {
        const p = _fetch.apply(this, arguments);
        return p.finally(dec);
      } catch (err) {
        dec(); throw err;
      }
    };
  }

  // 4) patch XMLHttpRequest (ph√≤ng khi lib d√πng XHR)
  if (window.XMLHttpRequest) {
    const _open = XMLHttpRequest.prototype.open;
    const _send = XMLHttpRequest.prototype.send;
    XMLHttpRequest.prototype.open = function(method, url){
      this.__track = shouldTrack(url);
      return _open.apply(this, arguments);
    };
    XMLHttpRequest.prototype.send = function(){
      if (this.__track) inc(this.responseURL || 'xhr');
      this.addEventListener('loadend', dec, { once: true });
      return _send.apply(this, arguments);
    };
  }

  // 5) l·ªô tr√¨nh public (tu·ª≥ ch·ªçn): c√≥ th·ªÉ g·ªçi th·ªß c√¥ng khi c·∫ßn
  window.GLOBAL_LOADING = {
    start: (msg)=> { inc('manual'); show(msg||'ƒêang t·∫£i...'); },
    stop:  ()=> { active = 1; dec(); } // ƒë·∫£m b·∫£o hide d√π b·ªã l·ªách ƒë·∫øm
  };
})();
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ===== Helpers (fix reject lu√¥n l√† Error)
const $ = (s)=>document.querySelector(s);
const toastEl = $('#toast'); const toast = new bootstrap.Toast(toastEl);
const notify = (msg)=>{
  $('#toastBody').textContent = (typeof msg === 'string' ? msg : (msg?.message || String(msg)));
  toast.show();
};

// Lu√¥n n√©m Error object thay v√¨ primitive/string
const asJson = async (r)=>{
  if (r.ok) return r.json();
  const t = await r.text();
  throw new Error(t || `${r.status} ${r.statusText}`);
};
const asOk = async (r)=>{
  if (r.ok) return true;
  const t = await r.text();
  throw new Error(t || `${r.status} ${r.statusText}`);
};


// ===== API wrappers
const API = {
  baoCaoDoanhThu: (y,m)=> fetch(`/api/bao-cao/doanh-thu?year=${y}&month=${m}`).then(asJson),
  congSuatPhong:  (y,m)=> fetch(`/api/bao-cao/cong-suat-phong?year=${y}&month=${m}`).then(asJson),
  topDichVu:      (y,m,limit)=> fetch(`/api/bao-cao/dich-vu-ban-chay?year=${y}&month=${m}&limit=${limit||5}`).then(asJson),

  
  // Kh√°ch h√†ng
  khachGet:   (id)=> fetch(`/api/khach/${encodeURIComponent(id)}`).then(r=>r.ok?r.json():null),
  khachCreate:(body)=> fetch('/api/khach',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(asJson),
  khachUpdate:(id,body)=> fetch(`/api/khach/${encodeURIComponent(id)}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(asJson),
  khachDelete:(id)=> fetch(`/api/khach/${encodeURIComponent(id)}`,{method:'DELETE'}).then(asOk),

  // Ph√≤ng
  timPhongTrong:(payload)=> fetch('/api/dat-phong/tim-phong-trong',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).then(asJson),
  addPhong:    async (p)=>{
    let res = await fetch('/api/core-flow/them-phong',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
    if(!res.ok && res.status===404){
      res = await fetch('/api/phong',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
    }
    return asJson(res);
  },
  delPhong:    (ma)=> fetch(`/api/phong/${encodeURIComponent(ma)}`,{method:'DELETE'}).then(asOk),

  // Orchestrator
  coreDatThanhToan:(body)=> fetch('/api/core-flow/dat-phong-thanh-toan',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(asJson),

  // D·ªãch v·ª• + CTDV
  listDichVu:  ()=> fetch('/api/dich-vu').then(r=>r.ok?r.json():[]),
  addDichVu:   async (d)=>{
    let res = await fetch('/api/core-flow/them-dich-vu',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
    if(!res.ok && res.status===404){
      res = await fetch('/api/dich-vu',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)});
    }
    return asJson(res);
  },
  delDichVu:   (ma)=> fetch(`/api/dich-vu/${encodeURIComponent(ma)}`,{method:'DELETE'}).then(asOk),

  listCTDV:    (maDP)=> fetch(`/api/ctdv/booking/${encodeURIComponent(maDP)}`).then(r=>r.ok?r.json():[]),
  addCTDV:     (maDP, body)=> fetch(`/api/ctdv/booking/${encodeURIComponent(maDP)}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(asJson),
  delCTDV:     (id)=> fetch(`/api/ctdv/${id}`, { method:'DELETE' }).then(asOk),

  // Booking theo kh√°ch
  bookingsByKh:(id)=> fetch(`/api/dat-phong/khach/${encodeURIComponent(id)}`).then(r=>r.ok?r.json():[]),
  bookingOne:  (maDP)=> fetch(`/api/dat-phong/${encodeURIComponent(maDP)}`).then(r=>r.ok?r.json():null),

  // Ho√° ƒë∆°n
  hdAll:       ()=> fetch('/api/hoa-don').then(r=>r.ok?r.json():[]),
  hdByBooking: (maDP)=> fetch(`/api/hoa-don/booking/${encodeURIComponent(maDP)}`).then(r=>r.ok?r.json():null),
  hdOne:       (maHD)=> fetch(`/api/hoa-don/${encodeURIComponent(maHD)}`).then(r=>r.ok?r.json():null)
};


  // ===== State
  let currentDP = null;
  let chartOcc, chartDV;
  const fmtVND = (x)=> (x||0).toLocaleString('vi-VN');
  const fmtPct = (x)=> ((x||0)*100).toFixed(1) + '%';

  let phongTrongData = [];
  let page = 1, pageSize = 10;

  // ===== Kh√°ch h√†ng helpers
  function gatherCustomerForm(){
    return {
      dinhDanh: $('#kh_dinhDanh').value.trim(),
      hoTen: $('#kh_hoTen').value.trim(),
      gioiTinh: $('#kh_gioiTinh').value || null,
      ngaySinh: $('#kh_ngaySinh').value || null,
      soDienThoai: $('#kh_sdt').value.trim() || null,
      email: $('#kh_email').value.trim() || null,
      diaChi: $('#kh_diaChi').value.trim() || null,
      quocTich: $('#kh_quocTich').value.trim() || null
    };
  }
  function fillCustomerForm(kh){
    if(!kh) return;
    $('#kh_dinhDanh').value = kh.dinhDanh || '';
    $('#kh_hoTen').value = kh.hoTen || '';
    $('#kh_gioiTinh').value = kh.gioiTinh || '';
    $('#kh_ngaySinh').value = kh.ngaySinh || '';
    $('#kh_sdt').value = kh.soDienThoai || '';
    $('#kh_email').value = kh.email || '';
    $('#kh_diaChi').value = kh.diaChi || '';
    $('#kh_quocTich').value = kh.quocTich || '';
    $('#dinhDanhKhach').value = $('#kh_dinhDanh').value;
  }

  // ===== Render ph√≤ng (ph√¢n trang)
  function renderPhongPage(){
    const tb = $('#tblPhongTrong');
    if(!phongTrongData || phongTrongData.length === 0){
      tb.innerHTML = `<tr><td colspan="6" class="muted">Kh√¥ng c√≥ ph√≤ng tr·ªëng ph√π h·ª£p</td></tr>`;
      $('#pagerInfo').textContent = `0/0`;
      $('#btnPrev').disabled = true; $('#btnNext').disabled = true;
      return;
    }
    const start = (page-1)*pageSize;
    const items = phongTrongData.slice(start, start + pageSize);
    tb.innerHTML = items.map(p=>`
      <tr>
        <td>${p.maPhong}</td><td>${p.loaiPhong || '-'}</td>
        <td>${p.soNguoiToiDa ?? '-'}</td>
        <td>${p.giaMoiDem?.toLocaleString('vi-VN') ?? '-'}</td>
        <td>${p.tinhTrang || '-'}</td>
        <td><button class="btn btn-soft btn-xs" onclick="chonPhong('${p.maPhong}')">Ch·ªçn</button></td>
      </tr>`).join('');
    const end = Math.min(start + items.length, phongTrongData.length);
    $('#pagerInfo').textContent = `${start + 1}-${end} / ${phongTrongData.length}`;
    $('#btnPrev').disabled = page === 1;
    $('#btnNext').disabled = end >= phongTrongData.length;
  }
  $('#btnPrev').addEventListener('click', ()=>{ if(page>1){ page--; renderPhongPage(); }});
  $('#btnNext').addEventListener('click', ()=>{ if((page*pageSize) < phongTrongData.length){ page++; renderPhongPage(); }});
  window.chonPhong = (ma)=>{ $('#maPhong').value = ma; notify('ƒê√£ ch·ªçn ph√≤ng ' + ma); };

  // ===== Render CTDV
  function renderCTDV(list){
    const tb = $('#tblCTDV');
    if(!list || list.length===0){ tb.innerHTML = `<tr><td colspan="5" class="muted">Ch∆∞a c√≥ d·ªãch v·ª•</td></tr>`; return; }
    tb.innerHTML = list.map(c=>`
      <tr>
        <td>${c.id}</td><td>${c.maDichVu}</td><td>${c.soLuong}</td>
        <td>${(c.thanhTien||0).toLocaleString('vi-VN')}</td>
        <td><button class="btn btn-outline-danger btn-xs" onclick="delCT(${c.id})">Xo√°</button></td>
      </tr>`).join('');
  }
  window.delCT = async (id)=>{ try{ await API.delCTDV(id); notify('ƒê√£ xo√° d·ªãch v·ª•'); const dp = getActiveDP(); if(dp) loadCTDV(dp); }catch(e){ notify(e); } };

  // ===== Render HO√Å ƒê∆†N (c√≥ n√∫t Thanh to√°n & xo√° KH)
  function renderHDList(list){
    const tb = $('#tblHDList');
    if(!list || list.length===0){
      tb.innerHTML = `<tr><td colspan="8" class="muted">Kh√¥ng c√≥ ho√° ƒë∆°n</td></tr>`;
        return;
    }
    tb.innerHTML = list.map(hd=>`
      <tr>
        <td>${hd.maHoaDon}</td>
        <td>${(hd.tongTienPhong||0).toLocaleString('vi-VN')}</td>
        <td>${(hd.tongTienDichVu||0).toLocaleString('vi-VN')}</td>
        <td>${(hd.thue||0).toLocaleString('vi-VN')}</td>
        <td>${(hd.giamGia||0).toLocaleString('vi-VN')}</td>
        <td><strong>${(hd.tongThanhToan||0).toLocaleString('vi-VN')}</strong></td>
        <td>${hd.ngayThanhToan || '-'}</td>
        <td>
          <button class="btn btn-outline-success btn-xs"
                  onclick="payAndDelete('${hd.maHoaDon}', '${hd.maDatPhong ?? ''}')">
            Thanh to√°n & xo√° KH
          </button>
        </td>
      </tr>
    `).join('');
  }

  // ===== Booking helpers for DV section
  function getActiveDP(){
    const manual = $('#dpMaDP').value.trim();
    if(manual) return manual;
    const sel = $('#selBooking'); if(sel && sel.value) return sel.value;
    return currentDP?.maDatPhong || null;
  }
  async function loadBookingsForCustomer(id){
    const list = await API.bookingsByKh(id).catch(()=>[]);
    const sel = $('#selBooking');
    sel.innerHTML = (list||[]).map(d=>`<option value="${d.maDatPhong}">${d.maDatPhong} ‚Äî ${d.ngayNhan}‚Üí${d.ngayTra} (${d.trangThai})</option>`).join('');
    if(list && list.length){
      sel.value = list[0].maDatPhong;
      $('#dpMaDP').value = sel.value;
      await loadCTDV(sel.value);
      const hd = await API.hdByBooking(sel.value);
      renderHDList(hd? [hd]: []);
    } else {
      sel.innerHTML = "";
      renderCTDV([]);
      renderHDList([]);
    }
  }

  async function loadDichVu(){
    const list = await API.listDichVu().catch(()=>[]);
    $('#selDichVu').innerHTML = (list||[]).map(d=>`<option value="${d.maDichVu}">${d.maDichVu} ‚Äî ${d.tenDichVu} (${(d.gia||0).toLocaleString('vi-VN')})</option>`).join('');
  }
  async function loadCTDV(maDP){ const list = await API.listCTDV(maDP).catch(()=>[]); renderCTDV(list); }

  // ===== Actions: pay & delete customer
  window.payAndDelete = async (maHD, maDP) => {
    try {
      const res = await fetch('/api/core-flow/pay-and-clean', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          maHoaDon: maHD,
          checkoutFirst: true,     // ƒë√°nh d·∫•u tr·∫£ ph√≤ng
          deleteBooking: true      // xo√° booking sau khi xo√° Hƒê
        })
      }).then(r => r.ok ? r.json() : r.text().then(t=>Promise.reject(t)));

      const msg = [
        res.message || 'ƒê√£ x·ª≠ l√Ω',
        `checkout=${res.daCheckout ? 'OK' : '‚Äî'}`,
        `xo√°CTDV=${res.daXoaCTDV ? 'OK' : '‚Äî'}`,
        `xo√°Hƒê=${res.daXoaHoaDon ? 'OK' : '‚Äî'}`,
        `xo√°Booking=${res.daXoaBooking ? 'OK' : '‚Äî'}`,
        `xo√°KH=${res.daXoaKhach ? 'OK' : '‚Äî'}`
      ].join(' | ');
      notify(msg);

      // refresh danh s√°ch Hƒê
      const list = await API.hdAll().catch(()=>[]);
      renderHDList(list);
    } catch (e) {
      notify(typeof e === 'string' ? e : (e?.message || 'L·ªói pay-and-clean'));
    }
  };
  // ===== Events: KH
  $('#btnKiemTraKH').addEventListener('click', async ()=>{
    const id = $('#kh_dinhDanh').value.trim();
    if(!id){ notify('Nh·∫≠p ƒë·ªãnh danh KH'); return; }
    const kh = await API.khachGet(id);
    if(kh){ fillCustomerForm(kh); notify('ƒê√£ t·∫£i th√¥ng tin kh√°ch h√†ng'); }
    else { $('#dinhDanhKhach').value = id; notify('Ch∆∞a c√≥ kh√°ch n√†y ‚Äî nh·∫≠p th√¥ng tin v√† b·∫•m L∆∞u KH'); }
  });
  $('#btnLuuKH').addEventListener('click', async ()=>{
    const data = gatherCustomerForm();
    if(!data.dinhDanh){ notify('Thi·∫øu ƒë·ªãnh danh KH'); return; }
    if(!data.hoTen){ notify('Thi·∫øu h·ªç t√™n KH'); return; }
    const existed = await API.khachGet(data.dinhDanh);
    try{
      if(existed){ await API.khachUpdate(data.dinhDanh, data); notify('ƒê√£ c·∫≠p nh·∫≠t kh√°ch h√†ng'); }
      else { await API.khachCreate(data); notify('ƒê√£ t·∫°o kh√°ch h√†ng'); }
      $('#dinhDanhKhach').value = data.dinhDanh;
    }catch(e){ notify(e); }
  });
  $('#btnXoaKH').addEventListener('click', async ()=>{
    const id = $('#kh_dinhDanh').value.trim();
    if(!id){ notify('Nh·∫≠p ƒë·ªãnh danh KH ƒë·ªÉ xo√°'); return; }
    try{ await API.khachDelete(id); notify('ƒê√£ xo√° kh√°ch ' + id); }
    catch(e){ notify(e); }
  });

  // ===== Events: T√¨m ph√≤ng
  $('#btnTim').addEventListener('click', async ()=>{
    const nhan = $('#nhan').value, tra = $('#tra').value;
    const soNguoi = parseInt($('#soNguoi').value || '1',10);
    const loaiPhong = $('#loaiPhong').value || null;
    if(!nhan || !tra){ notify('Vui l√≤ng ch·ªçn ng√†y nh·∫≠n/tr·∫£'); return; }
    if(new Date(tra) <= new Date(nhan)){ notify('Ng√†y tr·∫£ ph·∫£i sau ng√†y nh·∫≠n'); return; }
    try{
      const list = await API.timPhongTrong({ ngayNhan: nhan, ngayTra: tra, soNguoi, loaiPhong });
      phongTrongData = list || []; page = 1; renderPhongPage(); notify(`T·∫£i ${phongTrongData.length} ph√≤ng tr·ªëng`);
    }catch(e){ notify(e); }
  });

  // ===== Events: Orchestrator
  $('#btnDatThanhToan').addEventListener('click', async ()=>{
    const dinhDanhKhach = ($('#dinhDanhKhach').value.trim() || $('#kh_dinhDanh').value.trim());
    const maPhong = $('#maPhong').value.trim();
    const soKhach = parseInt($('#soKhach').value || '1',10);
    const giamGia = parseFloat($('#giamGia').value || '0');
    const phuongThuc = $('#phuongThuc').value || 'TIEN_MAT';
    const nhan = $('#nhan').value, tra = $('#tra').value;

    if(!dinhDanhKhach || !maPhong || !nhan || !tra){ notify('Thi·∫øu tr∆∞·ªùng b·∫Øt bu·ªôc'); return; }
    if(new Date(tra) <= new Date(nhan)){ notify('Ng√†y tr·∫£ ph·∫£i sau ng√†y nh·∫≠n'); return; }

    // ƒê·∫£m b·∫£o KH t·ªìn t·∫°i
    let kh = await API.khachGet(dinhDanhKhach);
    if(!kh){
      const data = gatherCustomerForm();
      if((data.dinhDanh||'') !== dinhDanhKhach) data.dinhDanh = dinhDanhKhach;
      if(!data.hoTen){ notify('Kh√°ch ch∆∞a t·ªìn t·∫°i. Nh·∫≠p H·ªç t√™n ·ªü m·ª•c 0) v√† b·∫•m L∆∞u KH tr∆∞·ªõc.'); return; }
      try{ await API.khachCreate(data); }catch(e){ notify(e); return; }
    }

    try{
      const kq = await API.coreDatThanhToan({ dinhDanhKhach, maPhong, ngayNhan: nhan, ngayTra: tra, soKhach, dichVuSoLuong: {}, giamGia, phuongThuc });
      currentDP = { maDatPhong: kq.maDatPhong };
      $('#status').innerHTML = `ƒê√£ t·∫°o ƒë·∫∑t ph√≤ng <strong>${kq.maDatPhong}</strong> & ho√° ƒë∆°n <strong>${kq.maHoaDon}</strong>. Ph·∫£i tr·∫£: <strong>${(kq.tongThanhToan||0).toLocaleString('vi-VN')}</strong>`;
      $('#dpMaDP').value = kq.maDatPhong;
      await loadCTDV(kq.maDatPhong);
      const hd = await API.hdByBooking(kq.maDatPhong); renderHDList(hd? [hd] : []);
      notify('ƒê·∫∑t ph√≤ng & thanh to√°n th√†nh c√¥ng');
    }catch(e){ notify(e); }
  });

  // ===== Events: D·ªãch v·ª•
  $('#btnLoadBooking').addEventListener('click', async ()=>{
    const id = $('#dv_dinhDanh').value.trim();
    if(!id){ notify('Nh·∫≠p ƒë·ªãnh danh KH ƒë·ªÉ t·∫£i booking'); return; }
    try{ await loadBookingsForCustomer(id); notify('ƒê√£ t·∫£i booking c·ªßa KH'); }catch(e){ notify(e); }
  });
  $('#selBooking').addEventListener('change', async (e)=>{
    const maDP = e.target.value; if(!maDP) return;
    $('#dpMaDP').value = maDP; await loadCTDV(maDP); const hd = await API.hdByBooking(maDP); renderHDList(hd? [hd] : []);
  });
  $('#btnThemDV').addEventListener('click', async ()=>{
    const maDP = getActiveDP();
    if(!maDP){ notify('Ch∆∞a ch·ªçn/nh·∫≠p m√£ ƒë·∫∑t ph√≤ng'); return; }
    const maDichVu = $('#selDichVu').value;
    const soLuong = parseInt($('#soLuongDV').value || '1',10);
    if(!maDichVu || soLuong<=0){ notify('Ch·ªçn d·ªãch v·ª• v√† s·ªë l∆∞·ª£ng > 0'); return; }
    try{ await API.addCTDV(maDP, { maDichVu, soLuong }); await loadCTDV(maDP); const hd = await API.hdByBooking(maDP); renderHDList(hd? [hd] : []); notify('ƒê√£ th√™m d·ªãch v·ª•'); }
    catch(e){ notify(e); }
  });

  // ===== Events: Ho√° ƒë∆°n
  $('#btnHDAll').addEventListener('click', async ()=>{
    const list = await API.hdAll().catch(()=>[]);
    renderHDList(list);
    notify(`T·∫£i ${list.length} ho√° ƒë∆°n`);
  });
  $('#btnHDByKh').addEventListener('click', ()=>{
    notify('Nh·∫≠p ƒë·ªãnh danh KH ·ªü √¥ b√™n ph·∫£i r·ªìi b·∫•m T·∫£i');
  });
  $('#btnLoadHDByKh').addEventListener('click', async ()=>{
    const id = $('#hdKhDinhDanh').value.trim();
    if(!id){ notify('Nh·∫≠p ƒë·ªãnh danh KH ƒë·ªÉ l·ªçc'); return; }
    try{
      const bookings = await API.bookingsByKh(id).catch(()=>[]);
      const res = [];
      for(const b of bookings){
        const hd = await API.hdByBooking(b.maDatPhong).catch(()=>null);
        if(hd) res.push(hd);
      }
      renderHDList(res);
      notify(`T·∫£i ${res.length} ho√° ƒë∆°n theo KH`);
    }catch(e){ notify(e); }
  });

  // ===== Events: Admin xo√°
  $('#btnXoaPhong').addEventListener('click', async ()=>{
    const ma = $('#delMaPhong').value.trim();
    if(!ma){ notify('Nh·∫≠p m√£ ph√≤ng ƒë·ªÉ xo√°'); return; }
    try{ await API.delPhong(ma); notify('ƒê√£ xo√° ph√≤ng ' + ma); }catch(e){ notify(e); }
  });
  $('#btnXoaDV').addEventListener('click', async ()=>{
    const ma = $('#delMaDV').value.trim();
    if(!ma){ notify('Nh·∫≠p m√£ DV ƒë·ªÉ xo√°'); return; }
    try{ await API.delDichVu(ma); await loadDichVu(); notify('ƒê√£ xo√° d·ªãch v·ª• ' + ma); }catch(e){ notify(e); }
  });

  // ===== Events: Admin th√™m
  $('#btnThemPhong').addEventListener('click', async ()=>{
    const body = {
      maPhong: $('#newMaPhong').value.trim(),
      loaiPhong: $('#newLoaiPhong').value,
      giaMoiDem: parseFloat($('#newGia').value || '0'),
      tinhTrang: $('#newTinhTrang').value,
      soNguoiToiDa: parseInt($('#newSucChua').value || '1',10),
      tienNghiKemTheo: $('#newTienNghi').value
    };
    if(!body.maPhong){ notify('Nh·∫≠p m√£ ph√≤ng'); return; }
    try{ await API.addPhong(body); notify('ƒê√£ th√™m ph√≤ng ' + body.maPhong); $('#newMaPhong').value=''; $('#newTienNghi').value=''; }catch(e){ notify(e); }
  });
  $('#btnThemDVAdmin').addEventListener('click', async ()=>{
    const body = { maDichVu: $('#newMaDV').value.trim(), tenDichVu: $('#newTenDV').value.trim(), gia: parseFloat($('#newGiaDV').value || '0'), loai: $('#newLoaiDV').value };
    if(!body.maDichVu || !body.tenDichVu){ notify('Nh·∫≠p m√£ & t√™n d·ªãch v·ª•'); return; }
    try{ await API.addDichVu(body); await loadDichVu(); notify('ƒê√£ th√™m d·ªãch v·ª• ' + body.maDichVu); $('#newMaDV').value=''; $('#newTenDV').value=''; }catch(e){ notify(e); }
  });

  // ===== Init
  (async function init(){
    const t = new Date(); const t2 = new Date(+t + 86400000);
    $('#nhan').value = t.toISOString().slice(0,10); $('#tra').value = t2.toISOString().slice(0,10);
    await loadDichVu();
    // ƒê·ªìng b·ªô ƒë·ªãnh danh gi·ªØa 0) v√† orchestrator
    $('#kh_dinhDanh').addEventListener('input',(e)=>{ $('#dinhDanhKhach').value = e.target.value; });
    $('#dinhDanhKhach').addEventListener('input',(e)=>{ $('#kh_dinhDanh').value = e.target.value; });
  })();

  async function loadBaoCao(){
  const y = parseInt($('#rp_year').value, 10);
  const m = parseInt($('#rp_month').value, 10);
  if(!y || !m || m<1 || m>12){ notify('NƒÉm/Th√°ng kh√¥ng h·ª£p l·ªá'); return; }

  try{
    // g·ªçi song song ƒë·ªÉ nhanh h∆°n
    const [dt, occ, top] = await Promise.all([
      API.baoCaoDoanhThu(y,m).catch(()=>({})),
      API.congSuatPhong(y,m).catch(()=>({})),
      API.topDichVu(y,m,7).catch(()=>([]))
    ]);
    
    // 1) KPI
    $('#kpi_tong').textContent  = fmtVND(dt.tongDoanhThu || 0);
    $('#kpi_phong').textContent = fmtVND(dt.doanhThuPhong || 0);
    $('#kpi_dv').textContent    = fmtVND(dt.doanhThuDichVu || 0);
    $('#kpi_thue').textContent  = fmtVND(dt.thue || 0);
    $('#kpi_giam').textContent  = fmtVND(dt.giamGia || 0);
    $('#kpi_occ').textContent   = fmtPct(occ.occupancy || 0);

    // 2) Chart C√¥ng su·∫•t
    const labelsOcc = (occ.byRoomType||[]).map(x=>x.loaiPhong);
    const valuesOcc = (occ.byRoomType||[]).map(x=> Math.round(((x.occupancy||0)*100)));
    if(chartOcc){ chartOcc.destroy(); }
    chartOcc = new Chart(document.getElementById('chartOcc'), {
      type: 'bar',
      data: { labels: labelsOcc, datasets: [{ label: 'Occupancy (%)', data: valuesOcc }] },
      options: {
        responsive: true,
        plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=> ctx.raw + '%' } } },
        scales:{ y:{ beginAtZero:true, max:100, ticks:{ callback:(v)=> v + '%' } } }
      }
    });

    // 3) Chart Top d·ªãch v·ª•
    const labelsDV = (top||[]).map(x=> x.tenDichVu || x.maDichVu);
    const valuesDV = (top||[]).map(x=> x.doanhThu || 0);
    if(chartDV){ chartDV.destroy(); }
    chartDV = new Chart(document.getElementById('chartDV'), {
      type: 'bar',
      data: { labels: labelsDV, datasets: [{ label: 'Doanh thu (VND)', data: valuesDV }] },
      options: {
        indexAxis: 'y',
        responsive: true,
        plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=> fmtVND(ctx.raw) + ' VND' } } },
        scales:{ x:{ ticks:{ callback:(v)=> fmtVND(v) } } }
      }
    });

    notify(`ƒê√£ t·∫£i b√°o c√°o th√°ng ${m}/${y}`);
  }catch(e){
    notify(e?.message || 'Kh√¥ng t·∫£i ƒë∆∞·ª£c b√°o c√°o');
  }
}

// G·∫Øn s·ª± ki·ªán & auto t·∫£i khi m·ªü trang
window.addEventListener('DOMContentLoaded', () => {
  const t = new Date();
  $('#rp_year').value  = t.getFullYear();
  $('#rp_month').value = t.getMonth() + 1;
  $('#btnLoadReport').addEventListener('click', loadBaoCao);
  loadBaoCao(); // g·ªçi l·∫ßn ƒë·∫ßu khi DOM ƒë√£ s·∫µn s√†ng
});



</script>

</body>
</html>
